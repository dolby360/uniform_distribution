# Step 8.2: Create and Boot Android Emulator

## Goal

Create an Android Virtual Device (AVD) and boot it using command-line tools. Verify it is reachable via `adb` and can install/launch apps. This emulator will be used for all subsequent validation steps.

## Prerequisites

- Step 8.1 completed (SDK, platform-tools, emulator, system image installed)
- `ANDROID_HOME` set and `avdmanager`, `emulator`, `adb` on PATH
- Hyper-V available for hardware acceleration (confirmed on this machine)

## Detailed Actions

### 1. Check Hardware Acceleration

```bash
emulator -accel-check
```

Expected output: `WHPX (Windows Hypervisor Platform) is installed and usable.`

If acceleration is not available, the emulator will be extremely slow. On this Windows 11 machine with Hyper-V, WHPX should be available.

### 2. Create AVD (Android Virtual Device)

```bash
avdmanager create avd \
  --name "uniform_dist_test" \
  --package "system-images;android-34;google_apis;x86_64" \
  --device "pixel_6" \
  --force
```

Parameters:
- `--name`: AVD name used to launch it later
- `--package`: Must match an installed system image from Step 8.1
- `--device`: Hardware profile (Pixel 6 has a good screen size for testing)
- `--force`: Overwrite if AVD already exists

### 3. Verify AVD Was Created

```bash
avdmanager list avd
```

Expected: Shows `uniform_dist_test` with details.

### 4. Start the Emulator

**With GUI** (recommended for interactive testing):
```bash
emulator -avd uniform_dist_test -no-snapshot-load -gpu host &
```

**Headless** (for automated testing/CI):
```bash
emulator -avd uniform_dist_test -no-window -no-audio -no-snapshot-load -gpu swiftshader_indirect &
```

Flags:
- `-no-snapshot-load`: Fresh boot every time (avoids stale state)
- `-gpu host`: Use host GPU for rendering (faster, requires GPU drivers)
- `-gpu swiftshader_indirect`: Software rendering (headless mode, slower but works without display)
- `-no-window`: No emulator window (headless)
- `-no-audio`: Disable audio (avoids audio driver issues)

### 5. Wait for Emulator to Boot

```bash
# Wait for device to be reachable
adb wait-for-device

# Poll for boot completion (max 180 seconds)
timeout=180
elapsed=0
while [ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" != "1" ] && [ $elapsed -lt $timeout ]; do
  echo "Waiting for boot... ($elapsed seconds)"
  sleep 5
  elapsed=$((elapsed + 5))
done

if [ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" = "1" ]; then
  echo "Emulator booted successfully!"
else
  echo "ERROR: Emulator failed to boot within $timeout seconds"
fi
```

**Note**: First boot can take 2-5 minutes. Subsequent boots with snapshots are faster.

### 6. Verify Emulator Is Running

```bash
# Check device list
adb devices

# Get device properties
adb shell getprop ro.build.version.sdk    # Should show "34"
adb shell getprop ro.product.model        # Should show "sdk_gphone64_x86_64" or similar
```

### 7. Test Basic Device Operations

```bash
# List installed packages
adb shell pm list packages | head -5

# Check internet connectivity from emulator
adb shell ping -c 3 google.com

# Check available camera devices (emulator provides virtual cameras)
adb shell ls /dev/video*
```

## Emulator Camera for Testing

The Android emulator provides simulated cameras:
- **Back camera**: Shows a moving virtual scene (animated room)
- **Front camera**: Shows a checkered pattern or webcam

For testing the Uniform Distribution app, the virtual camera will capture a synthetic image. This is sufficient to validate the camera flow end-to-end. The backend (Gemini Vision) may or may not detect clothing in the synthetic scene, but the flow will work.

## Stopping the Emulator

When done testing:
```bash
adb emu kill
```

Or to kill by PID:
```bash
kill $(pgrep -f "emulator.*uniform_dist_test")
```

## Edge Cases & Troubleshooting

| Issue | Solution |
|-------|----------|
| `emulator: ERROR: x86_64 emulation currently requires hardware acceleration` | Enable WHPX: `bcdedit /set hypervisorlaunchtype auto` then reboot |
| Emulator starts but screen is black | Try `-gpu swiftshader_indirect` instead of `-gpu host` |
| `adb wait-for-device` hangs forever | Kill emulator, restart with different GPU flag |
| Boot takes >5 minutes | Normal for first boot; create snapshot after boot: `adb emu avd snapshot save fresh_boot` |
| Port conflict on 5554 | Use `-port 5556` flag to use different port |
| `PANIC: Missing emulator engine program` | Ensure `$ANDROID_HOME/emulator` is on PATH (not just `$ANDROID_HOME/tools/emulator`) |

## Checklist

- [ ] Hardware acceleration check passes (`emulator -accel-check`)
- [ ] AVD `uniform_dist_test` created successfully
- [ ] `avdmanager list avd` shows the AVD
- [ ] Emulator starts without errors
- [ ] `adb devices` shows `emulator-5554` (or similar) as `device`
- [ ] `adb shell getprop sys.boot_completed` returns `1`
- [ ] SDK version is 34: `adb shell getprop ro.build.version.sdk`
- [ ] Internet works from emulator: `adb shell ping -c 1 google.com`
- [ ] Can list system packages: `adb shell pm list packages | head -3`
- [ ] Emulator can be stopped cleanly: `adb emu kill`

## Validation Commands

```bash
# 1. AVD exists
avdmanager list avd 2>/dev/null | grep "uniform_dist_test"

# 2. Emulator running and connected
adb devices | grep "emulator"

# 3. Boot completed
adb shell getprop sys.boot_completed | tr -d '\r'
# Expected: "1"

# 4. Correct API level
adb shell getprop ro.build.version.sdk | tr -d '\r'
# Expected: "34"

# 5. Network connectivity
adb shell ping -c 1 -W 5 google.com 2>&1 | grep "1 received"
# Expected: shows "1 received"
```
