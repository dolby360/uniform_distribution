# Step 8.7: Match Confirmation Screen

## Goal

Implement the MatchConfirmationScreen that displays results from `/process-outfit`, shows matched/new items with their images and similarity scores, and lets the user confirm a match or add a new item. After user action, calls the appropriate backend endpoint (`/confirm-match` or `/add-new-item`) and navigates back to HomeScreen.

## Prerequisites

- Step 8.6 completed (camera screen sends photos and receives responses)
- Step 8.5 completed (data layer with all API models and repository)

## Files to Create

All under `android/app/src/main/java/com/uniformdist/app/`:

```
ui/screens/confirmation/
  MatchConfirmationScreen.kt       # Main confirmation UI
  MatchConfirmationViewModel.kt    # State management + API calls
ui/components/
  ItemCard.kt                      # Reusable clothing item card
  LoadingOverlay.kt                # Reusable loading indicator
```

## Files to Modify

```
ui/navigation/NavGraph.kt          # Replace confirmation stub with real screen
```

## Navigation Data Flow

The `ProcessOutfitResponse` is passed from CameraScreen to MatchConfirmationScreen via navigation arguments:

```
CameraScreen
  → Moshi serializes ProcessOutfitResponse to JSON string
  → URL-encode the JSON
  → navController.navigate("match_confirmation/{encoded_json}")

MatchConfirmationScreen
  → Reads "resultJson" from nav argument
  → URL-decode
  → Moshi deserializes back to ProcessOutfitResponse
```

## Key Code

### ui/screens/confirmation/MatchConfirmationViewModel.kt

```kotlin
package com.uniformdist.app.ui.screens.confirmation

import androidx.lifecycle.SavedStateHandle
import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import com.squareup.moshi.Moshi
import com.squareup.moshi.kotlin.reflect.KotlinJsonAdapterFactory
import com.uniformdist.app.data.model.ItemMatchResult
import com.uniformdist.app.data.model.ProcessOutfitResponse
import com.uniformdist.app.data.repository.OutfitRepository
import dagger.hilt.android.lifecycle.HiltViewModel
import kotlinx.coroutines.flow.MutableStateFlow
import kotlinx.coroutines.flow.StateFlow
import kotlinx.coroutines.flow.asStateFlow
import kotlinx.coroutines.launch
import java.net.URLDecoder
import javax.inject.Inject

data class ConfirmationUiState(
    val matchResults: ProcessOutfitResponse? = null,
    val isLoading: Boolean = false,
    val shirtHandled: Boolean = false,
    val pantsHandled: Boolean = false,
    val error: String? = null
) {
    val isDone: Boolean get() = shirtHandled && pantsHandled
}

@HiltViewModel
class MatchConfirmationViewModel @Inject constructor(
    savedStateHandle: SavedStateHandle,
    private val repository: OutfitRepository
) : ViewModel() {

    private val _uiState = MutableStateFlow(ConfirmationUiState())
    val uiState: StateFlow<ConfirmationUiState> = _uiState.asStateFlow()

    init {
        val resultJson = savedStateHandle.get<String>("resultJson") ?: ""
        val decoded = URLDecoder.decode(resultJson, "UTF-8")
        val moshi = Moshi.Builder().addLast(KotlinJsonAdapterFactory()).build()
        val adapter = moshi.adapter(ProcessOutfitResponse::class.java)
        val response = adapter.fromJson(decoded)

        _uiState.value = ConfirmationUiState(
            matchResults = response,
            shirtHandled = response?.shirt == null,   // auto-complete if no shirt detected
            pantsHandled = response?.pants == null     // auto-complete if no pants detected
        )
    }

    fun confirmMatch(itemType: String, item: ItemMatchResult) {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(isLoading = true, error = null)
            try {
                repository.confirmMatch(
                    itemId = item.item_id ?: return@launch,
                    itemType = itemType,
                    originalPhotoUrl = _uiState.value.matchResults?.original_photo_url ?: "",
                    similarityScore = item.similarity
                )
                markHandled(itemType)
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    isLoading = false,
                    error = "Failed to confirm: ${e.message}"
                )
            }
        }
    }

    fun addNewItem(itemType: String, item: ItemMatchResult) {
        viewModelScope.launch {
            _uiState.value = _uiState.value.copy(isLoading = true, error = null)
            try {
                repository.addNewItem(
                    itemType = itemType,
                    croppedImageUrl = item.cropped_url ?: "",
                    embedding = item.embedding ?: emptyList(),
                    originalPhotoUrl = _uiState.value.matchResults?.original_photo_url ?: "",
                    logWear = true
                )
                markHandled(itemType)
            } catch (e: Exception) {
                _uiState.value = _uiState.value.copy(
                    isLoading = false,
                    error = "Failed to add item: ${e.message}"
                )
            }
        }
    }

    private fun markHandled(itemType: String) {
        _uiState.value = when (itemType) {
            "shirt" -> _uiState.value.copy(isLoading = false, shirtHandled = true)
            "pants" -> _uiState.value.copy(isLoading = false, pantsHandled = true)
            else -> _uiState.value.copy(isLoading = false)
        }
    }
}
```

### ui/screens/confirmation/MatchConfirmationScreen.kt

```kotlin
package com.uniformdist.app.ui.screens.confirmation

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.rememberScrollState
import androidx.compose.foundation.verticalScroll
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.unit.dp
import androidx.hilt.navigation.compose.hiltViewModel
import coil.compose.AsyncImage
import com.uniformdist.app.data.model.ItemMatchResult

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun MatchConfirmationScreen(
    onDone: () -> Unit,
    viewModel: MatchConfirmationViewModel = hiltViewModel()
) {
    val uiState by viewModel.uiState.collectAsState()

    LaunchedEffect(uiState.isDone) {
        if (uiState.isDone) onDone()
    }

    Scaffold(
        topBar = { TopAppBar(title = { Text("Confirm Matches") }) }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
                .verticalScroll(rememberScrollState())
                .padding(16.dp)
        ) {
            if (uiState.matchResults?.shirt == null && uiState.matchResults?.pants == null) {
                // No items detected
                Box(
                    modifier = Modifier.fillMaxWidth().padding(32.dp),
                    contentAlignment = Alignment.Center
                ) {
                    Column(horizontalAlignment = Alignment.CenterHorizontally) {
                        Text(
                            "No clothing items detected",
                            style = MaterialTheme.typography.titleMedium
                        )
                        Spacer(modifier = Modifier.height(8.dp))
                        Text(
                            "Try taking another photo with better lighting",
                            style = MaterialTheme.typography.bodyMedium,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                        Spacer(modifier = Modifier.height(16.dp))
                        Button(onClick = onDone) { Text("Go Back") }
                    }
                }
            }

            // Shirt section
            if (!uiState.shirtHandled) {
                uiState.matchResults?.shirt?.let { shirt ->
                    ItemMatchSection(
                        itemType = "Shirt",
                        item = shirt,
                        isLoading = uiState.isLoading,
                        onConfirm = { viewModel.confirmMatch("shirt", shirt) },
                        onAddNew = { viewModel.addNewItem("shirt", shirt) }
                    )
                    Spacer(modifier = Modifier.height(16.dp))
                }
            }

            // Pants section
            if (!uiState.pantsHandled) {
                uiState.matchResults?.pants?.let { pants ->
                    ItemMatchSection(
                        itemType = "Pants",
                        item = pants,
                        isLoading = uiState.isLoading,
                        onConfirm = { viewModel.confirmMatch("pants", pants) },
                        onAddNew = { viewModel.addNewItem("pants", pants) }
                    )
                }
            }

            // Error
            uiState.error?.let { error ->
                Spacer(modifier = Modifier.height(16.dp))
                Card(
                    colors = CardDefaults.cardColors(
                        containerColor = MaterialTheme.colorScheme.errorContainer
                    )
                ) {
                    Text(
                        error,
                        modifier = Modifier.padding(16.dp),
                        color = MaterialTheme.colorScheme.onErrorContainer
                    )
                }
            }
        }
    }
}

@Composable
private fun ItemMatchSection(
    itemType: String,
    item: ItemMatchResult,
    isLoading: Boolean,
    onConfirm: () -> Unit,
    onAddNew: () -> Unit
) {
    Card(
        modifier = Modifier.fillMaxWidth(),
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            Text(
                text = itemType,
                style = MaterialTheme.typography.titleLarge
            )

            Spacer(modifier = Modifier.height(12.dp))

            // Show the image
            val imageUrl = if (item.matched) item.image_url else item.cropped_url
            imageUrl?.let { url ->
                AsyncImage(
                    model = url,
                    contentDescription = "$itemType image",
                    modifier = Modifier
                        .size(200.dp)
                        .clip(MaterialTheme.shapes.medium),
                    contentScale = ContentScale.Crop
                )
            }

            Spacer(modifier = Modifier.height(12.dp))

            if (item.matched) {
                Text(
                    text = "Match: ${((item.similarity ?: 0.0) * 100).toInt()}%",
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.primary
                )
                Spacer(modifier = Modifier.height(12.dp))
                Row(horizontalArrangement = Arrangement.spacedBy(8.dp)) {
                    Button(
                        onClick = onConfirm,
                        enabled = !isLoading
                    ) {
                        Text("Confirm Match")
                    }
                    OutlinedButton(
                        onClick = onAddNew,
                        enabled = !isLoading
                    ) {
                        Text("Add as New")
                    }
                }
            } else {
                Text(
                    text = "New Item Detected",
                    style = MaterialTheme.typography.titleMedium,
                    color = MaterialTheme.colorScheme.tertiary
                )
                Spacer(modifier = Modifier.height(12.dp))
                Button(
                    onClick = onAddNew,
                    enabled = !isLoading
                ) {
                    Text("Add to Wardrobe")
                }
            }
        }
    }
}
```

### ui/components/ItemCard.kt

```kotlin
package com.uniformdist.app.ui.components

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.draw.clip
import androidx.compose.ui.layout.ContentScale
import androidx.compose.ui.unit.dp
import coil.compose.AsyncImage

@Composable
fun ItemCard(
    imageUrl: String?,
    label: String,
    modifier: Modifier = Modifier
) {
    Card(
        modifier = modifier.width(120.dp),
        elevation = CardDefaults.cardElevation(defaultElevation = 2.dp)
    ) {
        Column(
            modifier = Modifier.padding(8.dp),
            horizontalAlignment = Alignment.CenterHorizontally
        ) {
            imageUrl?.let {
                AsyncImage(
                    model = it,
                    contentDescription = label,
                    modifier = Modifier
                        .size(100.dp)
                        .clip(MaterialTheme.shapes.small),
                    contentScale = ContentScale.Crop
                )
            }
            Spacer(modifier = Modifier.height(4.dp))
            Text(label, style = MaterialTheme.typography.bodySmall)
        }
    }
}
```

### ui/components/LoadingOverlay.kt

```kotlin
package com.uniformdist.app.ui.components

import androidx.compose.foundation.layout.*
import androidx.compose.material3.*
import androidx.compose.runtime.Composable
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.unit.dp

@Composable
fun LoadingOverlay(
    message: String = "Loading..."
) {
    Surface(
        modifier = Modifier.fillMaxSize(),
        color = MaterialTheme.colorScheme.scrim.copy(alpha = 0.5f)
    ) {
        Box(contentAlignment = Alignment.Center) {
            Card {
                Column(
                    modifier = Modifier.padding(32.dp),
                    horizontalAlignment = Alignment.CenterHorizontally
                ) {
                    CircularProgressIndicator()
                    Spacer(modifier = Modifier.height(16.dp))
                    Text(message)
                }
            }
        }
    }
}
```

### NavGraph.kt Update

Replace the MatchConfirmation stub:

```kotlin
// Replace the MatchConfirmation stub in NavGraph.kt with:
composable(
    route = Screen.MatchConfirmation.route,
    arguments = listOf(navArgument("resultJson") { type = NavType.StringType })
) {
    MatchConfirmationScreen(
        onDone = {
            navController.popBackStack(Screen.Home.route, inclusive = false)
        }
    )
}
```

## Navigation Flow Summary

```
HomeScreen → [tap FAB] → CameraScreen → [capture + API call] →
→ MatchConfirmationScreen → [confirm/add for shirt + pants] →
→ HomeScreen (back stack cleared)
```

## Edge Cases & Troubleshooting

| Issue | Solution |
|-------|----------|
| URL-encoded JSON too long for nav argument | JSON should be < 2MB; if too long, use a shared ViewModel instead |
| JSON decode fails | Ensure URL encoding/decoding is symmetric (encode in Camera, decode in VM) |
| No shirt or pants detected | Screen shows "No clothing items detected" with back button |
| Only shirt detected (no pants) | `pantsHandled` starts as `true`, only shirt section shows |
| Confirm/add fails (network error) | Error card shown below the items |
| Both items handled → auto-navigate | `LaunchedEffect(uiState.isDone)` triggers `onDone()` |
| Image URL expired (signed URL) | Signed URLs typically valid for 1 hour; should be fine |
| Large embedding list (1408 doubles) | Sent as JSON array; Moshi handles this |

## Checklist

- [ ] `MatchConfirmationViewModel.kt` created with:
  - [ ] JSON deserialization of `ProcessOutfitResponse` from nav argument
  - [ ] `confirmMatch()` method calling repository
  - [ ] `addNewItem()` method calling repository
  - [ ] `isDone` tracking (both shirt and pants handled)
  - [ ] Error state handling
  - [ ] Auto-completion for undetected items (shirt/pants null)
- [ ] `MatchConfirmationScreen.kt` created with:
  - [ ] Shirt section showing image, match %, confirm/add buttons
  - [ ] Pants section showing image, match %, confirm/add buttons
  - [ ] "New Item Detected" variant for unmatched items
  - [ ] "No clothing items detected" empty state
  - [ ] Error display card
  - [ ] Auto-navigate to Home when all items handled
  - [ ] Loading state disables buttons
- [ ] `ItemCard.kt` created (reusable component)
- [ ] `LoadingOverlay.kt` created (reusable component)
- [ ] `NavGraph.kt` updated with real `MatchConfirmationScreen`
- [ ] `./gradlew assembleDebug` → BUILD SUCCESSFUL
- [ ] Full navigation flow compiles: Home → Camera → Confirmation → Home
- [ ] No crashes on navigation
- [ ] Images load from URLs via Coil

## Validation Commands

```bash
cd c:/Users/dolev/Downloads/personal/uniform_distribution/android

# 1. Build
./gradlew assembleDebug 2>&1 | tail -3
# Expected: "BUILD SUCCESSFUL"

# 2. Install
adb install -r app/build/outputs/apk/debug/app-debug.apk

# 3. Launch
adb shell am start -n com.uniformdist.app/.MainActivity
sleep 2

# 4. No crashes
adb logcat -d -s AndroidRuntime:E | grep "com.uniformdist" | head -3
# Expected: empty

# 5. Screenshot after navigating through flow
adb shell screencap -p /sdcard/step_8_7_confirmation.png
adb pull /sdcard/step_8_7_confirmation.png ./
```
