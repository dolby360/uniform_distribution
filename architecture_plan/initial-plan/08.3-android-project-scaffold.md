# Step 8.3: Scaffold Android/Gradle Project

## Goal

Create the entire Android project directory structure under `android/` with all Gradle configuration files, the Gradle wrapper, AndroidManifest, and resource files. After this step, `./gradlew tasks` should succeed — proving the project structure and build configuration are correct.

## Prerequisites

- Step 8.1 completed (Android SDK installed, `ANDROID_HOME` set)
- JDK 17 available

## Directory Structure to Create

```
android/
├── settings.gradle.kts
├── build.gradle.kts                          # Project-level
├── gradle.properties
├── local.properties
├── gradle/
│   └── wrapper/
│       ├── gradle-wrapper.jar
│       └── gradle-wrapper.properties
├── gradlew                                    # Unix wrapper script
├── gradlew.bat                                # Windows wrapper script
└── app/
    ├── build.gradle.kts                       # App-level (all dependencies)
    ├── proguard-rules.pro                     # Empty initially
    └── src/
        ├── main/
        │   ├── AndroidManifest.xml
        │   ├── java/com/uniformdist/app/      # Empty (code in Step 8.4)
        │   └── res/
        │       └── values/
        │           ├── strings.xml
        │           └── themes.xml
        ├── test/
        │   └── java/com/uniformdist/app/      # Empty (tests in Step 8.8)
        └── androidTest/
            └── java/com/uniformdist/app/      # Empty (tests in Step 8.9)
```

## Detailed Actions

### 1. Create Directory Structure

```bash
BASE="c:/Users/dolev/Downloads/personal/uniform_distribution/android"

mkdir -p "$BASE/app/src/main/java/com/uniformdist/app"
mkdir -p "$BASE/app/src/main/res/values"
mkdir -p "$BASE/app/src/test/java/com/uniformdist/app"
mkdir -p "$BASE/app/src/androidTest/java/com/uniformdist/app"
mkdir -p "$BASE/gradle/wrapper"
```

### 2. Create `settings.gradle.kts`

```kotlin
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}

dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}

rootProject.name = "UniformDist"
include(":app")
```

### 3. Create Project-Level `build.gradle.kts`

```kotlin
plugins {
    id("com.android.application") version "8.2.2" apply false
    id("org.jetbrains.kotlin.android") version "1.9.22" apply false
    id("com.google.dagger.hilt.android") version "2.50" apply false
    id("com.google.devtools.ksp") version "1.9.22-1.0.17" apply false
}
```

**Version Compatibility Matrix**:
| Component | Version | Reason |
|-----------|---------|--------|
| AGP | 8.2.2 | Latest stable for Gradle 8.5 |
| Kotlin | 1.9.22 | Matches KSP and Compose compiler |
| KSP | 1.9.22-1.0.17 | Must exactly match Kotlin version |
| Compose Compiler | 1.5.8 | Compatible with Kotlin 1.9.22 |
| Gradle | 8.5 | Required by AGP 8.2.2 |

### 4. Create `gradle.properties`

```properties
org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
org.gradle.parallel=true
android.useAndroidX=true
kotlin.code.style=official
android.nonTransitiveRClass=true
```

### 5. Create `local.properties`

```properties
sdk.dir=C\:\\Users\\dolev\\Android\\Sdk
```

**Note**: On Windows, backslashes must be escaped in `.properties` files. The `\:` escapes the colon, `\\` escapes each backslash.

### 6. Create `app/build.gradle.kts`

```kotlin
plugins {
    id("com.android.application")
    id("org.jetbrains.kotlin.android")
    id("com.google.dagger.hilt.android")
    id("com.google.devtools.ksp")
}

android {
    namespace = "com.uniformdist.app"
    compileSdk = 34

    defaultConfig {
        applicationId = "com.uniformdist.app"
        minSdk = 26
        targetSdk = 34
        versionCode = 1
        versionName = "1.0"

        testInstrumentationRunner = "androidx.test.runner.AndroidJUnitRunner"
    }

    buildFeatures {
        compose = true
    }

    composeOptions {
        kotlinCompilerExtensionVersion = "1.5.8"
    }

    compileOptions {
        sourceCompatibility = JavaVersion.VERSION_17
        targetCompatibility = JavaVersion.VERSION_17
    }

    kotlinOptions {
        jvmTarget = "17"
    }
}

dependencies {
    // Compose BOM
    val composeBom = platform("androidx.compose:compose-bom:2024.02.00")
    implementation(composeBom)
    implementation("androidx.compose.material3:material3")
    implementation("androidx.compose.ui:ui-tooling-preview")
    implementation("androidx.activity:activity-compose:1.8.2")
    implementation("androidx.navigation:navigation-compose:2.7.6")
    implementation("androidx.lifecycle:lifecycle-viewmodel-compose:2.7.0")
    implementation("androidx.lifecycle:lifecycle-runtime-compose:2.7.0")

    // Networking
    implementation("com.squareup.retrofit2:retrofit:2.9.0")
    implementation("com.squareup.retrofit2:converter-moshi:2.9.0")
    implementation("com.squareup.moshi:moshi-kotlin:1.15.0")
    ksp("com.squareup.moshi:moshi-kotlin-codegen:1.15.0")
    implementation("com.squareup.okhttp3:okhttp:4.12.0")
    implementation("com.squareup.okhttp3:logging-interceptor:4.12.0")

    // Image loading
    implementation("io.coil-kt:coil-compose:2.5.0")

    // CameraX
    val cameraxVersion = "1.3.1"
    implementation("androidx.camera:camera-core:$cameraxVersion")
    implementation("androidx.camera:camera-camera2:$cameraxVersion")
    implementation("androidx.camera:camera-lifecycle:$cameraxVersion")
    implementation("androidx.camera:camera-view:$cameraxVersion")

    // Permissions (missing from original plan, needed by CameraScreen)
    implementation("com.google.accompanist:accompanist-permissions:0.34.0")

    // Hilt
    implementation("com.google.dagger:hilt-android:2.50")
    ksp("com.google.dagger:hilt-compiler:2.50")
    implementation("androidx.hilt:hilt-navigation-compose:1.1.0")

    // Testing - Unit
    testImplementation("junit:junit:4.13.2")
    testImplementation("org.mockito:mockito-core:5.8.0")
    testImplementation("org.mockito.kotlin:mockito-kotlin:5.2.1")
    testImplementation("org.jetbrains.kotlinx:kotlinx-coroutines-test:1.7.3")
    testImplementation("com.squareup.okhttp3:mockwebserver:4.12.0")
    testImplementation("androidx.arch.core:core-testing:2.2.0")

    // Testing - Instrumented
    androidTestImplementation(composeBom)
    androidTestImplementation("androidx.test.ext:junit:1.1.5")
    androidTestImplementation("androidx.test.espresso:espresso-core:3.5.1")
    androidTestImplementation("androidx.compose.ui:ui-test-junit4")
    debugImplementation("androidx.compose.ui:ui-test-manifest")
    debugImplementation("androidx.compose.ui:ui-tooling")
}
```

### 7. Create `app/proguard-rules.pro`

```proguard
# Empty - rules added in Step 8.10
```

### 8. Create `app/src/main/AndroidManifest.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-feature android:name="android.hardware.camera" android:required="true" />
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.INTERNET" />

    <application
        android:name=".UniformDistApp"
        android:allowBackup="true"
        android:label="@string/app_name"
        android:supportsRtl="true"
        android:theme="@style/Theme.UniformDist">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:configChanges="orientation|screenSize|screenLayout|keyboardHidden">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
```

### 9. Create `app/src/main/res/values/strings.xml`

```xml
<resources>
    <string name="app_name">Uniform Distribution</string>
</resources>
```

### 10. Create `app/src/main/res/values/themes.xml`

```xml
<?xml version="1.0" encoding="utf-8"?>
<resources>
    <style name="Theme.UniformDist" parent="android:Theme.Material.Light.NoActionBar" />
</resources>
```

### 11. Bootstrap Gradle Wrapper

Without Gradle installed globally, we need to download it to create the wrapper:

```bash
# Download Gradle 8.5 binary
curl -L -o /tmp/gradle-8.5-bin.zip \
  "https://services.gradle.org/distributions/gradle-8.5-bin.zip"

# Extract temporarily
unzip /tmp/gradle-8.5-bin.zip -d /tmp/

# Generate wrapper in the android/ project directory
cd "$BASE"
/tmp/gradle-8.5/bin/gradle wrapper --gradle-version 8.5

# Verify wrapper files exist
ls -la gradlew gradlew.bat gradle/wrapper/
```

This creates:
- `gradlew` (Unix shell script)
- `gradlew.bat` (Windows batch script)
- `gradle/wrapper/gradle-wrapper.jar`
- `gradle/wrapper/gradle-wrapper.properties`

### 12. Clean Up Temp Files

```bash
rm -rf /tmp/gradle-8.5 /tmp/gradle-8.5-bin.zip /tmp/commandlinetools.zip
```

## Edge Cases & Troubleshooting

| Issue | Solution |
|-------|----------|
| `local.properties` sdk.dir wrong format | Must use escaped backslashes: `C\:\\Users\\dolev\\Android\\Sdk` |
| KSP version mismatch | KSP version `1.9.22-1.0.17` must exactly match Kotlin `1.9.22` |
| Compose compiler mismatch | Compose compiler `1.5.8` is tied to Kotlin `1.9.22` |
| AGP requires newer Gradle | AGP 8.2.2 requires Gradle 8.2+; we use 8.5 |
| `./gradlew` permission denied | Run `chmod +x gradlew` |
| Gradle download fails | Check network; try direct download from browser as fallback |
| `Could not resolve all dependencies` | Check `repositories` blocks include both `google()` and `mavenCentral()` |

## Checklist

- [ ] All directories created (`app/src/main/java/...`, `test/`, `androidTest/`)
- [ ] `settings.gradle.kts` created with plugin repos and `:app` module
- [ ] Project-level `build.gradle.kts` created with correct plugin versions
- [ ] `gradle.properties` created with JVM args and AndroidX flag
- [ ] `local.properties` created with correct `sdk.dir` path (escaped backslashes)
- [ ] `app/build.gradle.kts` created with ALL dependencies including:
  - [ ] Compose BOM + Material 3
  - [ ] Retrofit + Moshi + OkHttp
  - [ ] CameraX (core, camera2, lifecycle, view)
  - [ ] Accompanist Permissions (was missing from original plan)
  - [ ] Hilt (android + compiler + navigation-compose)
  - [ ] Coil for image loading
  - [ ] Test dependencies (junit, mockito, coroutines-test, mockwebserver)
  - [ ] Android test dependencies (espresso, compose-ui-test)
- [ ] `AndroidManifest.xml` created with camera permission and activity declaration
- [ ] `strings.xml` and `themes.xml` created
- [ ] `proguard-rules.pro` created (empty placeholder)
- [ ] Gradle wrapper bootstrapped (`gradlew`, `gradlew.bat`, `gradle-wrapper.jar`)
- [ ] `./gradlew --version` outputs Gradle 8.5
- [ ] `./gradlew tasks` lists `assembleDebug` task
- [ ] No Gradle sync errors

## Validation Commands

```bash
cd c:/Users/dolev/Downloads/personal/uniform_distribution/android

# 1. Gradle wrapper works
./gradlew --version
# Expected: "Gradle 8.5"

# 2. Project structure correct
test -f settings.gradle.kts && test -f build.gradle.kts && \
test -f app/build.gradle.kts && test -f app/src/main/AndroidManifest.xml && \
echo "Structure OK"

# 3. Gradle can resolve tasks
./gradlew tasks 2>&1 | grep "assembleDebug"
# Expected: shows "assembleDebug" task

# 4. Dependencies resolve (first run downloads everything, ~5-10 min)
./gradlew dependencies --configuration debugRuntimeClasspath 2>&1 | tail -5
# Expected: no unresolved dependencies
```

**Note**: The first `./gradlew` run downloads Gradle distribution + all dependencies. This can take 5-10 minutes.
